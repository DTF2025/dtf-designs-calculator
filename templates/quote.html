<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DTF Designs Customer Calculator (Employee)</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">DTF Designs Customer Calculator (Employee)</h1>
            <a href="{{ url_for('customer') }}" class="btn btn-outline-secondary">Customer Page</a>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="card">
            <div class="card-body">
                <form method="POST" id="quoteForm">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category</label>
                            <select name="category" id="category" class="form-select" onchange="document.getElementById('quoteForm').submit()">
                                {% for c in categories %}
                                <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="customer_type" class="form-label">Customer Type</label>
                            <select name="customer_type" class="form-select">
                                {% for c in customer_types %}
                                <option value="{{ c }}" {% if c == 'wholesale' %}selected{% endif %}>{{ c|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    {% if selected_category in ["Wide Format", "Stickers"] %}
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label for="media_name" class="form-label">Media</label>
                            <select name="media_name" class="form-select">
                                {% for n in media_names %}
                                <option value="{{ n }}">{{ n }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="width_in" class="form-label">Width (in)</label>
                            <input type="number" step="0.01" name="width_in" value="72" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="height_in" class="form-label">Height (in)</label>
                            <input type="number" step="0.01" name="height_in" value="36" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="qty" class="form-label">Quantity</label>
                            <input type="number" step="1" name="qty" value="1" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="sides" class="form-label">Sides</label>
                            <input type="number" step="1" name="sides" value="1" class="form-control">
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="coverage" class="form-label">Coverage</label>
                            <select name="coverage" class="form-select">
                                {% for c in coverage_levels %}
                                <option value="{{ c }}" {% if c == 'Medium' %}selected{% endif %}>{{ c }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="special_colors" class="form-label">Special Colors?</label>
                            <select name="special_colors" class="form-select">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="hem_opt" class="form-label">Hem</label>
                            <select name="hem_opt" class="form-select">
                                <option value="All">All</option>
                                <option value="Top&Bottom">Top & Bottom</option>
                                <option value="None" selected>None</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="grommets" class="form-label">Grommets?</label>
                            <select name="grommets" class="form-select">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="grom_spacing_in" class="form-label">Grommet Spacing (in)</label>
                            <input type="number" step="1" name="grom_spacing_in" value="24" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="laminate" class="form-label">Laminate</label>
                            <select name="laminate" class="form-select">
                                <option value="">None</option>
                                {% for lam in laminate_options %}
                                <option value="{{ lam }}">{{ lam }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="labor_minutes" class="form-label">Labor Minutes</label>
                            <input type="number" step="1" name="labor_minutes" value="30" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="setup_fee_on" class="form-label">Setup Fee?</label>
                            <select name="setup_fee_on" class="form-select">
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    {% if selected_category == "Yard Signs" %}
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="per_unit_sku" class="form-label">Item</label>
                            <select name="per_unit_sku" class="form-select">
                                {% for it in yard_items %}
                                <option value="{{ it.sku }}">{{ it.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="qty" class="form-label">Quantity</label>
                            <input type="number" step="1" name="qty" value="10" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="add_stakes" class="form-label">Add H-stakes?</label>
                            <select name="add_stakes" class="form-select">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    {% if selected_category == "Apparel" %}
                    <div class="mb-3">
                        <h5>Apparel Items</h5>
                        <div id="apparelItems" class="mb-3"></div>
                        <button class="btn btn-secondary" type="button" onclick="addApparelItem()">+ Add Item</button>
                        <div class="form-text">Tier chosen by total qty per garment type. Discount hits base tier; size & extra placements are fixed adders.</div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="rush" class="form-label">Rush Order</label>
                            <select name="rush" class="form-select">
                                <option value="Standard">Standard</option>
                                <option value="Rush">Rush</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-primary" type="submit">Calculate Quote</button>
                        <small class="text-muted">WF Overhead: ${{ config.equip_overhead_per_sqft }}/sqft</small>
                    </div>
                </form>
            </div>
        </div>

        {% if result %}
        <div class="card mt-4">
            <div class="card-body">
                <h4 class="card-title">Quote Results</h4>
                
                <div class="table-responsive mb-4">
                    <table class="table table-sm">
                        {% if result.derived and result.derived.billable_sqft %}
                        <tr>
                            <th>Billable sq ft</th>
                            <td class="text-end">{{ result.derived.billable_sqft }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Your Cost</th>
                            <td class="text-end">${{ result.totals.your_cost }}</td>
                        </tr>
                        <tr class="table-success">
                            <th>Quoted Price</th>
                            <td class="text-end"><strong>${{ result.totals.quoted_price }}</strong></td>
                        </tr>
                        <tr>
                            <th>Unit Price</th>
                            <td class="text-end">${{ result.totals.unit_price }}</td>
                        </tr>
                    </table>
                </div>

                {% if result.lines %}
                <h5>Apparel Line Items</h5>
                <div class="table-responsive mb-4">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Garment</th>
                                <th>Size</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Unit</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ln in result.lines %}
                            <tr>
                                <td>{{ ln.garment }}</td>
                                <td>{{ ln.size }}</td>
                                <td class="text-end">{{ ln.qty }}</td>
                                <td class="text-end">${{ ln.unit }}</td>
                                <td class="text-end">${{ ln.total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {% if result.costs %}
                <h5>Cost Breakdown</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        {% for k, v in result.costs.items() %}
                        <tr>
                            <th>{{ k.replace('_', ' ').title() }}</th>
                            <td class="text-end">${{ v }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Apparel item management
        const garments = {{ apparel_garments|tojson }};
        const sizes = {{ size_options|tojson }};
        let itemIndex = 0;

        function createSelectOptions(list) {
            return list.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        function addApparelItem() {
            const container = document.getElementById('apparelItems');
            const itemHTML = `
                <div class="row g-2 mb-2 apparel-item" id="item-${itemIndex}">
                    <div class="col-md-3">
                        <select name="items-${itemIndex}-garment" class="form-select form-select-sm">
                            ${createSelectOptions(garments)}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="items-${itemIndex}-size" class="form-select form-select-sm">
                            ${createSelectOptions(sizes)}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input name="items-${itemIndex}-qty" type="number" min="1" value="12" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <input name="items-${itemIndex}-extras" type="number" min="0" value="0" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeApparelItem(${itemIndex})">Remove</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHTML);
            itemIndex++;
        }

        function removeApparelItem(index) {
            const element = document.getElementById(`item-${index}`);
            if (element) {
                element.remove();
            }
        }

        // Add initial apparel item if in apparel category
        {% if selected_category == "Apparel" %}
        addApparelItem();
        {% endif %}
    </script>
</body>
</html>
